# Development BUILD stage
FROM python:3.12-slim AS builder
RUN apt-get update && apt-get install -y curl build-essential
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.cargo/bin:$PATH"
WORKDIR /app
COPY pyproject.toml uv.lock ./
RUN uv sync --dev

# Development RUNTIME stage - includes uv + hot reload
FROM python:3.12-slim AS dev-runtime
RUN apt-get update && apt-get install -y curl build-essential
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
WORKDIR /app
COPY --from=builder /root/.local/share/uv/venvs /opt/venv
ENV PATH="/opt/venv/bin:$PATH:/root/.cargo/bin"
COPY . .
EXPOSE 8001
CMD ["bash", "-c", "uv sync --dev && sleep 5 && alembic upgrade head && uv run main.py"]
